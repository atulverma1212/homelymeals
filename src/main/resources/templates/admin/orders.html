<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Order</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .toast-container {
            z-index: 1056;
        }

        .toast {
            min-width: 300px;
        }

        .toast-header {
            background-color: #0d6efd !important;
        }

        .btn-close-white {
            filter: brightness(0) invert(1);
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="#">Kitchen Admin</a>
        <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbarContent">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarContent">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/admin/dashboard}">Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" th:href="@{/admin/orders}">Orders</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/admin/settings}">
                        <i class="bi bi-gear"></i> Settings
                    </a>
                </li>
            </ul>
            <form th:action="@{/logout}" method="post" class="d-flex">
                <button class="btn btn-outline-light" type="submit">Logout</button>
            </form>
        </div>
    </div>
</nav>

<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-primary text-white">
            <strong class="me-auto">New Order</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="notificationMessage">
        </div>
    </div>
</div>

<div class="container mt-4">
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show">
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <div th:if="${success}" class="alert alert-success alert-dismissible fade show">
        <span th:text="${success}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Order Management</h5>
            <div>
                <button class="btn btn-outline-primary me-2" onclick="filterOrders('all')">All</button>
                <button class="btn btn-outline-warning me-2" onclick="filterOrders('PENDING')">Pending</button>
                <button class="btn btn-outline-success me-2" onclick="filterOrders('COMPLETED')">Completed</button>
                <button class="btn btn-outline-danger" onclick="filterOrders('CANCELLED')">Cancelled</button>
            </div>
        </div>
        <div class="card-body">
            <table class="table table-hover">
                <thead>
                <tr>
                    <th>Order ID</th>
                    <th>Customer Name</th>
                    <th>Order Date</th>
                    <th>Status</th>
                    <th>Total Amount</th>
                    <th>Items</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="ordersTableBody">
                <tr th:each="order : ${orders}">
                    <td th:text="${order.id}">1</td>
                    <td th:text="${order.customerName}">John Doe</td>
                    <td th:text="${#temporals.format(order.orderDate, 'dd-MM-yyyy HH:mm')}">01-01-2024</td>
                    <td>
        <span th:class="${'badge ' +
        (order.status.name() == 'PENDING' ? 'bg-warning' :
        (order.status.name() == 'CONFIRMED' ? 'bg-info' :
        (order.status.name() == 'PREPARING' ? 'bg-primary' :
        (order.status.name() == 'READY' ? 'bg-success' :
        (order.status.name() == 'COMPLETED' ? 'bg-success' :
        (order.status.name() == 'OUT_FOR_DELIVERY' ? 'bg-info' :
        (order.status.name() == 'CANCELLED' ? 'bg-danger' : 'bg-secondary')))))))}"
              th:text="${order.status}">
        PENDING
        </span>
                    </td>
                    <td th:text="${'₹' + #numbers.formatDecimal(order.totalAmount, 1, 2)}">₹100.00</td>
                    <td>
                        <button class="btn btn-sm btn-info"
                                th:onclick="'viewOrderItems(' + ${order.id} + ')'">
                            View Items
                        </button>
                    </td>

                    <td>
                        <select class="form-select form-select-sm state-transition"
                                th:data-order-id="${order.id}"
                                style="width: auto;">
                            <option value="">Change status...</option>
                            <option th:each="status : ${orderTransitions.get(order.id)}"
                                    th:value="${status}"
                                    th:text="${#strings.toUpperCase(status)}">
                            </option>
                        </select>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Order Items Modal -->
<div class="modal fade" id="orderItemsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Order Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <table class="table">
                    <thead>
                    <tr>
                        <th>Item Name</th>
                        <th>Quantity</th>
                        <th>Unit Price</th>
                        <th>Subtotal</th>
                    </tr>
                    </thead>
                    <tbody id="orderItemsBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>


<script>
    function viewOrderItems(orderId) {
        fetch(`/admin/orders/${orderId}`)
            .then(response => response.json())
            .then(order => {
                const tbody = document.getElementById('orderItemsBody');
                tbody.innerHTML = '';
                order.items.forEach(item => {
                    tbody.innerHTML += `
        <tr>
        <td>${item.stockItem.name}</td>
        <td>${item.quantity} ${item.stockItem.unit}</td>
        <td>₹${item.unitPrice.toFixed(2)}</td>
        <td>₹${item.subtotal.toFixed(2)}</td>
        </tr>
        `;
                });
                new bootstrap.Modal(document.getElementById('orderItemsModal')).show();
            });
    }

    function updateOrderStatus(orderId, status) {
        fetch(`/admin/orders/${orderId}/status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({status: status})
        })
            .then(response => {
                if (response.ok) {
                    window.location.reload();
                }
            });
    }

    function filterOrders(status) {
        const url = status === 'all'
            ? '/admin/orders'
            : `/admin/orders?status=${status}`;
        window.location.href = url;
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Initialize all state transition selects
        document.querySelectorAll('.state-transition').forEach(select => {
            select.addEventListener('change', function() {
                const orderId = this.dataset.orderId;
                const newStatus = this.value;

                if (!newStatus) return;

                if (confirm(`Are you sure you want to change the status to ${newStatus.toLowerCase()}?`)) {
                    updateOrderStatus(orderId, newStatus);
                } else {
                    this.value = ''; // Reset selection
                }
            });
        });
    });

    function updateOrderStatus(orderId, status) {
        fetch(`/admin/orders/${orderId}/status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({status: status})
        })
            .then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    alert('Failed to update status');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to update status');
            });
    }

    //     Websockets implementation


    document.addEventListener('DOMContentLoaded', function () {
        // Wait for the page to fully load
        const connectWebSocket = () => {
            try {
                const socket = new SockJS('/ws');
                const stompClient = Stomp.over(socket);
                const toastElement = document.getElementById('notificationToast');
                // Configure toast with longer duration (10 seconds)
                const toast = new bootstrap.Toast(toastElement, {
                    animation: true,
                    autohide: true,
                    delay: 3000 // 10 seconds
                });

                stompClient.connect({}, function (frame) {
                    console.log('Connected to WebSocket');

                    stompClient.subscribe('/topic/admin-notifications', function (message) {
                        console.log('Received:', message.body);
                        document.getElementById('notificationMessage').textContent = message.body;
                        toast.show();

                        if (window.location.pathname === '/admin/orders') {
                            setTimeout(() => window.location.reload(), 5000);
                        }
                    });
                }, function (error) {
                    console.error('WebSocket error:', error);
                    setTimeout(connectWebSocket, 5000);
                });

                return stompClient;
            } catch (error) {
                console.error('WebSocket connection failed:', error);
                setTimeout(connectWebSocket, 5000);
            }
        };

        // Initialize WebSocket connection
        let stompClient = connectWebSocket();

        // Handle page unload
        window.addEventListener('beforeunload', () => {
            if (stompClient) {
                stompClient.disconnect();
            }
        });
    });
</script>
</body>
</html>